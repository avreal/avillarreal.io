---
title: "Simple Nornir Scenario 1"
urltitle: "nornirsc1"
date: 2020-06-20T15:10:27-07:00
draft: true
showdate: true
---


Now that we have seen how the output of Nornir can be used when run on a network, lets look at a scenario in which Nornir can prove useful.

# Simple Scenario

Suppose a customer has a large number of locations an MSP. They called in and created a ticket with support because they want to ensure that the arp table on the trusted network (Ethernet0/3) at all of their locations has only one device (a POS server perhaps). If a location has more than 1 device, they want the full arp output of those locations so they can investigate on their end, perhaps by comparing MAC addresses to their own list. There are hundreds of locations and doing this manually would be tedious and time consuming. We need to develop a script to check that the locations have only one device. They want to ensure that an attacker has not inserted a switch into the network and added their own device to the pos environment. Obviously there are configurations that could mitigate such a simple attack, but this customer has not provided details for us to do that so we will need to do this until a better solution is implemented. We can ignore the default gateway IP (192.168.30.1). Lets assume we already have an inventory file. This scenario and the associated files can be viewed on my {{< rawhtml >}}<a href="https://github.com/avreal/NetworkAutomationScenarios/tree/masterScenario1-VerifyArp" target = "_blank"><strong>github</strong></a> {{< /rawhtml >}}. 

So we need to do the following:

1. Take input (inventory)
2. Grab arp table from all of the devices
3. Parse the arp table and look for locations with multiple devices, as well as locations with an empty arp table.
4. Output the locations violating the policy

The lab is as follows(click [__here__](/1resources/images/intronornir/topology.PNG) for full size):

![topology](/1resources/images/intronornir/topology.PNG)

Based on the scenario, we can tell that locations ABC-001-0001 and ABC-001-0002 will cause an alert for too many devices, and ABC-001-0004 will cause an alert for being empty.

The code is as follows:

~~~python
from nornir import InitNornir
from nornir.plugins.tasks.networking import napalm_get
from nornir.plugins.functions.text import print_result

nr = InitNornir(config_file="./config.yaml")
result = nr.run(task=napalm_get,getters=["get_arp_table"])

#The full napalm output can be printed if needed as well
#print_result(result)

#create a list of entries specifying not to include the gateway IP and only checking interface Ethernet0/3
#locations with nothing in the arp table besides the interface itself on Ethernet 0/3 will be added to a separate list
arp_list = []
empty_arp_list = []
for x in result:
    for k in result[x].result['get_arp_table']:
        tmp_list = []
        if (k['interface'] == "Ethernet0/3") and (k['ip'] != "192.168.30.1"):
            arp_list.append({x:k})
            tmp_list.append({x:k})
    if len(tmp_list) == 0:
        empty_arp_list.append(x)

# This function will go through the result and create a list with the violations pertaining to having more than 1 MAC on the interface
total_entries = len(arp_list)
num_violation_locations = 0
violation_list = []
new_location_flag = True
for i in range(total_entries):
    if i == 0:
        continue
    elif arp_list[i].keys() == arp_list[i-1].keys() and new_location_flag == True:
        violation_list.append(arp_list[i])
        violation_list.append(arp_list[i-1])
        num_violation_locations += 1
        new_location_flag = False
    elif arp_list[i].keys() == arp_list[i-1].keys() and new_location_flag == False:
        violation_list.append(arp_list[i])
    elif arp_list[i].keys() != arp_list[i-1].keys():
        new_location_flag = True

print("We have found violations of the # of mac addresses policy on Ethernet 0/3 across", num_violation_locations, "locations. The full arp output of Ethernet 0/3 for all offending locations will be printed below")
for i in violation_list:
    print(i)

print("\nThe following locations have an empty arp table on Ethernet 0/3, indicating that there may be nothing plugged into the trust network, or whatever is on the trust network is not replying to ARP\n")
for i in empty_arp_list:
    print(i)
~~~
The input generated by the nr.run function is as follows:

~~~
This is sanitized output of the AggregatedResult object returned by nornir
>>> for x in result:
...     print(x)
...     for k in result[x].result['get_arp_table']:
...             print(k)

ABC-001-0001
{'interface': 'Ethernet0/0', 'mac': '0C:13:B8:43:CC:01', 'ip': '192.168.10.1', 'age': 34.0}
{'interface': 'Ethernet0/0', 'mac': 'AA:BB:CC:00:01:00', 'ip': '192.168.10.2', 'age': 0.0}
{'interface': 'Ethernet0/1', 'mac': 'AA:BB:CC:00:01:10', 'ip': '192.168.10.5', 'age': 0.0}
{'interface': 'Ethernet0/1', 'mac': 'AA:BB:CC:00:02:00', 'ip': '192.168.10.6', 'age': 51.0}
{'interface': 'Ethernet0/2', 'mac': 'AA:BB:CC:00:01:20', 'ip': '192.168.10.17', 'age': 0.0}
{'interface': 'Ethernet0/2', 'mac': 'AA:BB:CC:00:03:00', 'ip': '192.168.10.18', 'age': 36.0}
{'interface': 'Ethernet0/3', 'mac': 'AA:BB:CC:00:01:30', 'ip': '192.168.30.1', 'age': 0.0}
{'interface': 'Ethernet0/3', 'mac': '00:50:79:66:68:00', 'ip': '192.168.30.2', 'age': 171.0}
{'interface': 'Ethernet0/3', 'mac': '00:50:79:66:68:04', 'ip': '192.168.30.20', 'age': 7.0}
{'interface': 'Ethernet0/3', 'mac': '00:50:79:66:68:05', 'ip': '192.168.30.21', 'age': 218.0}
ABC-001-0002
{'interface': 'Ethernet0/0', 'mac': 'AA:BB:CC:00:01:10', 'ip': '192.168.10.5', 'age': 51.0}
{'interface': 'Ethernet0/0', 'mac': 'AA:BB:CC:00:02:00', 'ip': '192.168.10.6', 'age': 0.0}
{'interface': 'Ethernet0/1', 'mac': 'AA:BB:CC:00:02:10', 'ip': '192.168.10.9', 'age': 0.0}
{'interface': 'Ethernet0/1', 'mac': 'AA:BB:CC:00:04:00', 'ip': '192.168.10.10', 'age': 36.0}
{'interface': 'Ethernet0/3', 'mac': 'AA:BB:CC:00:02:30', 'ip': '192.168.30.1', 'age': 0.0}
{'interface': 'Ethernet0/3', 'mac': '00:50:79:66:68:01', 'ip': '192.168.30.3', 'age': 172.0}
{'interface': 'Ethernet0/3', 'mac': '00:50:79:66:68:06', 'ip': '192.168.30.50', 'age': 166.0}
ABC-001-0003
{'interface': 'Ethernet0/1', 'mac': 'AA:BB:CC:00:04:10', 'ip': '192.168.10.13', 'age': 36.0}
{'interface': 'Ethernet0/1', 'mac': 'AA:BB:CC:00:03:10', 'ip': '192.168.10.14', 'age': 0.0}
{'interface': 'Ethernet0/0', 'mac': 'AA:BB:CC:00:01:20', 'ip': '192.168.10.17', 'age': 36.0}
{'interface': 'Ethernet0/0', 'mac': 'AA:BB:CC:00:03:00', 'ip': '192.168.10.18', 'age': 0.0}
{'interface': 'Ethernet0/3', 'mac': 'AA:BB:CC:00:03:30', 'ip': '192.168.30.1', 'age': 0.0}
{'interface': 'Ethernet0/3', 'mac': '00:50:79:66:68:02', 'ip': '192.168.30.4', 'age': 171.0}
ABC-001-0004
{'interface': 'Ethernet0/0', 'mac': 'AA:BB:CC:00:02:10', 'ip': '192.168.10.9', 'age': 36.0}
{'interface': 'Ethernet0/0', 'mac': 'AA:BB:CC:00:04:00', 'ip': '192.168.10.10', 'age': 0.0}
{'interface': 'Ethernet0/1', 'mac': 'AA:BB:CC:00:04:10', 'ip': '192.168.10.13', 'age': 0.0}
{'interface': 'Ethernet0/1', 'mac': 'AA:BB:CC:00:03:10', 'ip': '192.168.10.14', 'age': 36.0}
{'interface': 'Ethernet0/3', 'mac': 'AA:BB:CC:00:04:30', 'ip': '192.168.30.1', 'age': 0.0}
~~~

The output is as follows:

~~~
We have found violations of the # of mac addresses policy on Ethernet 0/3 across 2 locations.
The full arp output of Ethernet 0/3 for all offending locations will be printed below
{'ABC-001-0001': {'interface': 'Ethernet0/3', 'mac': '00:50:79:66:68:04', 'ip': '192.168.30.20', 'age': 10.0}}
{'ABC-001-0001': {'interface': 'Ethernet0/3', 'mac': '00:50:79:66:68:00', 'ip': '192.168.30.2', 'age': 174.0}}
{'ABC-001-0001': {'interface': 'Ethernet0/3', 'mac': '00:50:79:66:68:05', 'ip': '192.168.30.21', 'age': 221.0}}
{'ABC-001-0002': {'interface': 'Ethernet0/3', 'mac': '00:50:79:66:68:06', 'ip': '192.168.30.50', 'age': 168.0}}
{'ABC-001-0002': {'interface': 'Ethernet0/3', 'mac': '00:50:79:66:68:01', 'ip': '192.168.30.3', 'age': 175.0}}

The following locations have an empty arp table on Ethernet 0/3, indicating 
that there may be nothing plugged into the trust network, or whatever is on 
the trust network is not replying to ARP

ABC-001-0004
~~~

The output is as expected! Of course a more refined script will have input validation, testing, and cleaner output, but this serves as a demonstration of the kinds of things Nornir can do. This example only had 4 locations but running this script on hundreds of locations would be incredibly fast compared to Ansible.
